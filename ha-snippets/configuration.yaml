# ============================================================
# Home Assistant — Configuração global Bluetooth
# Adicionar ao configuration.yaml (uma única vez).
# Quando adicionar uma nova divisão, actualizar:
#   - mapeamento de IPs nos dois scripts abaixo
# ============================================================


# --- Binary sensors: estado real da ligação Bluetooth (um por divisão) ---
# Entidade: binary_sensor.bt_<divisao>
# Âncora YAML definida no primeiro sensor — os restantes herdam os campos comuns.
# Requer /usr/local/bin/bt-status.sh em cada RPi (instalado via install.sh).

command_line:
  - binary_sensor: &bt_sensor
      name: bt_escritorio
      command: "ssh -i /root/.ssh/id_ed25519 -o StrictHostKeyChecking=no relvasantos@192.168.30.7 '/usr/local/bin/bt-status.sh'"
      payload_on: "1"
      payload_off: "0"
      device_class: connectivity
      scan_interval: 15

  - binary_sensor:
      <<: *bt_sensor
      name: bt_suite
      command: "ssh -i /root/.ssh/id_ed25519 -o StrictHostKeyChecking=no relvasantos@192.168.30.2 '/usr/local/bin/bt-status.sh'"

  - binary_sensor:
      <<: *bt_sensor
      name: bt_cozinha
      command: "ssh -i /root/.ssh/id_ed25519 -o StrictHostKeyChecking=no relvasantos@192.168.30.3 '/usr/local/bin/bt-status.sh'"

  - binary_sensor:
      <<: *bt_sensor
      name: bt_sala
      command: "ssh -i /root/.ssh/id_ed25519 -o StrictHostKeyChecking=no relvasantos@192.168.30.4 '/usr/local/bin/bt-status.sh'"

  - binary_sensor:
      <<: *bt_sensor
      name: bt_wcsuite
      command: "ssh -i /root/.ssh/id_ed25519 -o StrictHostKeyChecking=no relvasantos@192.168.30.5 '/usr/local/bin/bt-status.sh'"

  - binary_sensor:
      <<: *bt_sensor
      name: bt_quartocriancas
      command: "ssh -i /root/.ssh/id_ed25519 -o StrictHostKeyChecking=no relvasantos@192.168.30.6 '/usr/local/bin/bt-status.sh'"

  - binary_sensor:
      <<: *bt_sensor
      name: bt_quartodesporto
      command: "ssh -i /root/.ssh/id_ed25519 -o StrictHostKeyChecking=no relvasantos@192.168.30.1 '/usr/local/bin/bt-status.sh'"

  - binary_sensor:
      <<: *bt_sensor
      name: bt_teste
      command: "ssh -i /root/.ssh/id_ed25519 -o StrictHostKeyChecking=no relvasantos@192.168.30.8 '/usr/local/bin/bt-status.sh'"


# --- Shell commands (partilhados, não tocar) ---

shell_command:
  bt_pair:   "ssh -i /root/.ssh/id_ed25519 -o StrictHostKeyChecking=no {{ user }}@{{ ip }} '/usr/local/bin/bluetooth-control.sh pair'"
  bt_unpair: "ssh -i /root/.ssh/id_ed25519 -o StrictHostKeyChecking=no {{ user }}@{{ ip }} '/usr/local/bin/bluetooth-control.sh unpair'"


# --- Scripts (um único por acção, recebe divisao como argumento) ---

script:
  bt_pair:
    alias: "BT Ligar"
    fields:
      divisao:
        description: "Nome da divisão (escritorio, suite, cozinha, ...)"
        required: true
    sequence:
      - action: shell_command.bt_pair
        data:
          user: relvasantos
          ip: >-
            {% set ips = {
              'escritorio':    '192.168.30.7',
              'suite':         '192.168.30.2',
              'cozinha':       '192.168.30.3',
              'sala':          '192.168.30.4',
              'wcsuite':       '192.168.30.5',
              'quartocriancas':'192.168.30.6',
              'quartodesporto':'192.168.30.1',
              'teste':         '192.168.30.8'
            } %}
            {{ ips[divisao] }}
    mode: parallel
    max: 8

  bt_unpair:
    alias: "BT Desligar"
    fields:
      divisao:
        description: "Nome da divisão (escritorio, suite, cozinha, ...)"
        required: true
    sequence:
      - action: shell_command.bt_unpair
        data:
          user: relvasantos
          ip: >-
            {% set ips = {
              'escritorio':    '192.168.30.7',
              'suite':         '192.168.30.2',
              'cozinha':       '192.168.30.3',
              'sala':          '192.168.30.4',
              'wcsuite':       '192.168.30.5',
              'quartocriancas':'192.168.30.6',
              'quartodesporto':'192.168.30.1',
              'teste':         '192.168.30.8'
            } %}
            {{ ips[divisao] }}
    mode: parallel
    max: 8
